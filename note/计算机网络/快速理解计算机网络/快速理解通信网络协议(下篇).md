[快速裂解通信网络协议下篇]: http://www.ruanyifeng.com/blog/2012/06/internet_protocol_suite_part_ii.html

我们已经知道，网络通信就是提交数据包。电脑A向电脑B发送一个数据包，后者收到了，回复一个数据包，从而实现两台电脑之间的通信。数据包的结构，基本上是下面这样：

![](http://www.ruanyifeng.com/blogimg/asset/201205/bg2012052913.png)

发送这个包，需要知道两个地址：

```
对方的MAC地址
对方的IP地址
```

有了这两个地址，数据包才能准确送到接收者手中。但是，前面说过,MAC地址有局限性，如果两台电脑不在同一个子网络，就无法知道对方的MAC地址，必须通过网关转发。

![](http://www.ruanyifeng.com/blogimg/asset/201206/bg2012061101.jpg)

上图中，1号电脑要向4号电脑发送一个数据包。它先判断4号电脑是否在同一个子网络，结果发现不是(后文介绍判断方法)，于是就把这个数据包发到网关A。网关A通过路由协议，发现4号电脑于子网络B，网关B再转发到4号电脑。1号电脑把数据包发到网关A，必须知道网关A的MAC地址。所以，数据包的目标地址，实际上分成两种情况：

| 场景      | 数据包地址            |
| ------- | ---------------- |
| 同一个子网络  | 对方的MAC地址，对方的IP地址 |
| 非同一个子网络 | 网关的MAC地址，对方的IP地址 |

发送数据包之前，电脑必须判断对方是否在同一个子网络，然后选择相应的MAC地址。接下来，我们就来看，实际使用中。

+ 静态IP地址

  通常你必须做一些设置。有时，管理员(或者ISP)会告诉你下面四个参数，你把它们填入操作系统，计算机就能连上网了：

  ```
  本机的IP地址
  子网掩码
  网关的IP地址
  DNS的IP地址

  ```

+  DHCP协议

  首先，它是一种应用层协议，建立在UDP协议之上，所以真个数据包是这样的：

  ![](http://www.ruanyifeng.com/blogimg/asset/201206/bg2012061102.png)

  (1)最前面的“以太网标头”，设置发出方(本机)的MAC地址和接收方(DHCP服务器)的MAC地址。前者就是本机网卡的MAC地址，后者这时不知道，就填入一个广播地址：FF-FF-FF-FF-FF-FF。

  (2)后面的“IP标头”，设置发出方的IP地址和接收方的IP地址。这时，对于这两者，本机都不知道。于是，发出方的IP地址设为0.0.0.0，接收方的IP地址为255.255.255.255。

  (3)最后的“UDP标头”，设置发出方的端口和接收方的端口。这一部分是DHCP协议规定好的，发出方是68端口，接收方是67端口。

  这个数据包构造完成后，就可以发出了。以太网是广播发送，同一个子网络的每一台计算机都收到这个包。因为接收方的MAC地址是FF-FF-FF-FF-FF-FF，看不出来是发给谁的，所以每台收到这个包的计算机，还必须分析这个包的IP地址，才能确定是不是发给自己的。当看到发出方的IP地址是0.0.0.0，接收方255.255.255.255于是DHCP服务器知道“这个包是发给我的”，而其他计算机就可以丢弃这个包。